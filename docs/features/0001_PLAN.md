# Plan Técnico: Actualización Phaser 3.70.0 → 3.90.0 y Node.js 14 → 20

## Descripción

Actualizar el juego Triangles App desde Phaser 3.70.0 a la última versión estable 3.90.0 de la rama 3.x, y actualizar Node.js desde la versión 14.18.2 a la versión 20. El proyecto actualmente utiliza Webpack 4 con Babel 7 y está estructurado como una aplicación ES6 con módulos importados correctamente usando `import Phaser from 'phaser'`.

Según la recomendación de GPT-5, se sugiere mantener la estabilidad en Phaser 3.90.0 antes de considerar una migración futura a Phaser 4 (actualmente en RC5). También se evaluará la posibilidad de migrar de Webpack 4 a Vite para mejorar la experiencia de desarrollo.

## Estado Actual Identificado

### Versiones Actuales
- **Node.js**: 14.18.2 
- **Phaser**: 3.70.0 (en package.json)
- **Webpack**: 4.41.2
- **Babel**: 7.7.2

### Estructura de Importaciones de Phaser
- `src/phaser-ui/index.js`: `import Phaser from 'phaser'` ✅
- `src/phaser-ui/events-center.js`: `import Phaser from 'phaser'` ✅
- `src/phaser-ui/scenes/welcome-scene.js`: `import Phaser from 'phaser'` ✅
- Todas las escenas extienden correctamente `Phaser.Scene`

### Configuración de Build
- Webpack 4 con configuración en `webpack/base.js` y `webpack/prod.js`
- Babel configurado con preset-env para navegadores modernos
- Scripts npm: `start`, `build`, `test`, `deploy`

## Fase 1: Preparación y Backup

### Archivos a modificar:
- `package.json` - actualizar dependencias
- `package-lock.json` - será regenerado
- `.babelrc` - posible actualización de targets
- `webpack/base.js` - posible migración a Vite
- `webpack/prod.js` - posible migración a Vite

### Pasos:
1. **Crear rama de actualización**
   ```bash
   git checkout -b upgrade/phaser-3x-node-20
   ```

2. **Backup del estado actual**
   ```bash
   git tag v0.0.1-pre-upgrade
   ```

3. **Limpiar instalación**
   - Eliminar `node_modules/`
   - Eliminar `package-lock.json`

## Fase 2: Actualización de Node.js

### Archivos a modificar:
- `.babelrc` - actualizar target node a "20"
- `package.json` - posible actualización de engines field

### Pasos:
1. **Actualizar Node.js a versión 20** (usando nvm en macOS)
   ```bash
   nvm install 20
   nvm use 20
   ```

2. **Verificar compatibilidad de dependencias**
   - Revisar que todas las devDependencies sean compatibles con Node 20
   - Actualizar dependencias obsoletas si es necesario

## Fase 3A: Actualización de Phaser (Opción Conservadora)

### Archivos a modificar:
- `package.json` - actualizar phaser a "^3.90.0"

### Pasos:
1. **Actualizar Phaser**
   ```bash
   npm install phaser@^3.90.0
   ```

2. **Verificar importaciones** (ya están correctas)
   - Confirmar que `import Phaser from 'phaser'` funciona
   - Verificar que `new Phaser.Game()` y `new Phaser.Events.EventEmitter()` funcionen

3. **Revisar configuración de juego**
   - Verificar `src/phaser-ui/index.js` configuración del game
   - Comprobar que `Phaser.Scale.RESIZE` sigue siendo válido
   - Verificar `Phaser.AUTO` y otras constantes

## Fase 3B: Migración a Vite (Opción Moderna)

### Archivos a crear/modificar:
- `vite.config.js` - nueva configuración de Vite
- `package.json` - nuevos scripts y dependencias de Vite
- `index.html` - mover al root y actualizar referencias
- Eliminar archivos: `webpack/base.js`, `webpack/prod.js`

### Dependencias a instalar:
```json
{
  "devDependencies": {
    "vite": "^5.0.0"
  }
}
```

### Nuevos scripts en package.json:
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "start": "vite",
    "test": "jest"
  }
}
```

### Configuración vite.config.js:
```javascript
import { defineConfig } from 'vite'

export default defineConfig({
  root: '.',
  build: {
    outDir: 'dist'
  },
  server: {
    host: '0.0.0.0'
  }
})
```

## Fase 4: Verificación y Pruebas

### Archivos a revisar:
- Todos los archivos en `src/phaser-ui/scenes/` - verificar que las escenas funcionen
- `src/phaser-ui/index.js` - verificar inicialización del juego
- Assets en `src/assets/` - verificar carga correcta

### Pasos de verificación:
1. **Pruebas de funcionalidad básica**
   - Inicialización del juego
   - Transiciones entre escenas (Welcome → Players → Playing → Ending)
   - Carga de assets (imágenes, audio)
   - Eventos y input handling

2. **Pruebas de rendimiento**
   - FPS estable en diferentes dispositivos
   - Tiempo de carga inicial
   - Memoria utilizada

3. **Pruebas cross-browser**
   - Chrome/Android
   - Safari/iOS
   - Firefox
   - Edge

4. **Pruebas de audio**
   - Inicialización tras primera interacción del usuario
   - Reproducción de efectos de sonido y música

## Fase 5: Actualización de Dependencias Relacionadas

### Archivos a modificar:
- `package.json` - actualizar todas las devDependencies

### Dependencias a actualizar:
```json
{
  "devDependencies": {
    "@babel/core": "^7.23.0",
    "@babel/preset-env": "^7.23.0",
    "babel-jest": "^29.0.0",
    "eslint": "^8.50.0",
    "jest": "^29.0.0"
  }
}
```

### Dependencias a revisar:
- `firebase`: verificar compatibilidad con versión 9.6.1
- `i18next`: verificar si hay actualizaciones menores
- `uuid`: considerar actualizar a versión más reciente

## Fase 6: Optimizaciones Post-Actualización

### Archivos a optimizar:
- `src/phaser-ui/scenes/playing-scene.js` - revisar si hay nuevas APIs de Phaser 3.90
- Asset loading - optimizar con nuevas características del loader

### Optimizaciones potenciales:
1. **Loader improvements**
   - Verificar que todas las keys de assets sean únicas
   - Aprovechar mejoras en pack loading si aplica

2. **Input handling**
   - Revisar mejoras en input para móviles en Phaser 3.90

3. **Audio improvements**
   - Aprovechar mejoras en Web Audio API

## Criterios de Éxito

### Funcionalidad
- [ ] El juego inicia correctamente
- [ ] Todas las escenas funcionan como antes
- [ ] Audio se inicializa correctamente
- [ ] Assets se cargan sin errores
- [ ] Multiplayer funciona (Firebase integration)

### Rendimiento
- [ ] FPS mantiene 60fps en dispositivos de prueba
- [ ] Tiempo de carga inicial igual o mejor
- [ ] Build size igual o menor

### Compatibilidad
- [ ] Funciona en Chrome, Safari, Firefox, Edge
- [ ] Funciona en iOS y Android
- [ ] PWA funciona correctamente

## Rollback Plan

En caso de problemas críticos:
1. Revertir a tag `v0.0.1-pre-upgrade`
2. Usar Node.js 14 temporalmente
3. Mantener Phaser 3.70.0 hasta resolver issues

## Consideraciones Futuras

### Phaser 4 Migration
- Crear rama `upgrade/phaser-4` para experimentación
- Evaluar beneficios del nuevo motor WebGL "Beam"
- Considerar migración solo si se añaden nuevas features que lo requieran

### Performance Monitoring
- Implementar métricas de rendimiento
- Monitorear FPS en producción
- Tracking de errores post-actualización
